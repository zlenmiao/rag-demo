# 🤖 AI知识问答 - RAG对话功能使用指南

## 🎯 功能概述

新增的RAG（Retrieval-Augmented Generation）对话功能让您可以基于已清洗的知识库数据与AI进行智能对话。系统会自动检索相关知识内容，并结合这些信息为您提供准确、详细的回答。

## 🚀 功能特性

### 🔍 智能检索
- **中文分词技术**：自动提取问题中的关键词和词组
- **多字段匹配**：同时搜索摘要、关键词、分类、搜索向量等字段
- **相关性排序**：基于权重算法对检索结果进行智能排序
- **实时统计**：显示检索耗时、命中数量等详细信息

### 💬 对话体验
- **流畅界面**：现代化的聊天界面，支持实时消息显示
- **输入便利**：支持回车发送、Shift+回车换行
- **参考展示**：显示AI回答所依据的知识源
- **系统可配**：可自定义系统提示词调整AI行为

### 📊 知识溯源
- **知识片段展示**：每个回答都会显示相关的知识来源
- **分类标记**：清晰标注知识片段的分类和摘要
- **性能监控**：实时显示检索和AI响应的耗时统计

## 🛠️ 技术实现

### 1. 检索策略

#### **分词算法**
```javascript
// 简单中文分词示例
- 移除标点符号：，。！？；：""''（）【】《》
- 提取词组：2-4字的中文词组
- 过滤条件：包含中文字符、字母或数字
```

#### **相关性计算**
```javascript
// 权重分配
搜索向量匹配：权重 × 3.0
关键词匹配：权重 × 2.0
摘要匹配：权重 × 1.5
原文匹配：权重 × 0.5
```

### 2. API端点

#### **对话API**
```
POST /chat/ask
Content-Type: application/json

{
  "question": "用户问题",
  "system_prompt": "可选的系统提示词"
}
```

#### **响应格式**
```json
{
  "success": true,
  "answer": "AI回答内容",
  "sources": [
    {
      "content": "知识片段内容",
      "summary": "内容摘要",
      "category": "分类",
      "keywords": ["关键词1", "关键词2"]
    }
  ],
  "stats": {
    "search_time": 150,
    "ai_time": 800,
    "total_matches": 5,
    "sources_used": 3
  }
}
```

### 3. 系统提示词

#### **默认模板**
```text
你是一个专业的知识助手，专门基于提供的知识库内容回答用户问题。

回答要求：
1. 主要基于提供的知识库内容进行回答
2. 如果知识库中没有相关信息，请明确说明并提供一般性建议
3. 回答要准确、详细且有条理
4. 可以适当引用知识库中的具体内容
5. 保持友好和专业的语调

知识库内容：
{KNOWLEDGE_CONTEXT}

用户问题：{USER_QUESTION}
```

#### **占位符说明**
- `{KNOWLEDGE_CONTEXT}`：自动填入检索到的知识内容
- `{USER_QUESTION}`：用户的原始问题

## 📝 使用步骤

### 1. 准备知识库
1. 在"数据清洗"页面上传并清洗文本或图片内容
2. 确保清洗后的数据已保存到数据库
3. 在"数据管理"页面验证数据质量

### 2. 开始对话
1. 访问主页，点击"🤖 智能问答"
2. 等待知识库状态检查完成
3. 在输入框中输入您的问题
4. 按回车发送或点击发送按钮

### 3. 查看回答
1. 系统会显示"正在思考"的动画
2. AI回答会逐步显示
3. 查看"参考知识源"了解回答依据
4. 检查底部的性能统计信息

### 4. 调整设置（可选）
1. 点击"设置"按钮展开配置面板
2. 修改系统提示词以调整AI回答风格
3. 保存设置后继续对话

## 🔧 配置选项

### 环境变量
```bash
# AI API密钥（必需）
AI_API_KEY=your_deepseek_api_key

# Supabase配置（必需）
SUPABASE_URL=your_supabase_url
SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_KEY=your_supabase_service_key
```

### 参数调优
```javascript
// 可在代码中调整的参数
const SEARCH_LIMIT = 5;        // 检索结果数量
const MAX_TOKENS = 2000;       // AI回答最大token数
const TEMPERATURE = 0.3;       // AI回答随机性（0-1）
const SCORE_THRESHOLD = 0.1;   // 相关性阈值
```

## 📈 性能优化

### 1. 检索优化
- **预过滤**：先获取50条记录再进行相关性计算
- **缓存策略**：相同问题可考虑缓存检索结果
- **索引优化**：数据库字段建立适当索引

### 2. 响应优化
- **分词缓存**：常用词汇分词结果缓存
- **连接池**：数据库连接复用
- **并行处理**：检索和AI调用并行化

## 🐛 故障排除

### 常见问题

#### 1. 知识库状态显示"连接失败"
- 检查Supabase配置是否正确
- 验证数据库中是否有清洗后的数据
- 确认网络连接正常

#### 2. AI回答"未找到相关信息"
- 检查问题关键词是否与知识库内容匹配
- 尝试使用不同的表述方式
- 确认知识库中有足够的相关数据

#### 3. 响应速度慢
- 检查AI API密钥配额是否充足
- 考虑减少检索结果数量
- 优化数据库查询性能

#### 4. 系统提示词不生效
- 确认占位符格式正确
- 检查提示词长度是否合理
- 验证JSON格式是否正确

## 🚀 部署说明

### Workers版本
```bash
# 设置环境变量
wrangler secret put AI_API_KEY
wrangler secret put SUPABASE_URL
wrangler secret put SUPABASE_ANON_KEY
wrangler secret put SUPABASE_SERVICE_KEY

# 部署
wrangler deploy
```

### Pages版本
需要实现对应的Pages Functions API端点。

## 📚 使用示例

### 示例对话1：技术问题
```
用户：什么是深度学习？
AI：根据知识库内容，深度学习是机器学习的一个分支...
[显示相关知识源：深度学习技术.txt 中的相关段落]
```

### 示例对话2：操作指导
```
用户：如何使用Python进行数据分析？
AI：基于知识库中的Python编程资料，数据分析的步骤包括...
[显示相关知识源：Python编程基础.txt, 数据科学方法论.txt]
```

### 示例对话3：知识库外问题
```
用户：今天天气怎么样？
AI：抱歉，我的知识库中没有关于天气的实时信息。我专注于回答与技术文档相关的问题...
```

## 🎯 最佳实践

### 1. 问题表述
- 使用清晰、具体的问题描述
- 包含关键技术术语
- 避免过于宽泛的问题

### 2. 知识库管理
- 定期更新和清洗数据
- 确保知识分类准确
- 维护高质量的摘要和关键词

### 3. 系统提示词
- 根据知识库内容调整语言风格
- 明确回答的结构和格式要求
- 设置适当的免责声明

---

🎉 **现在就开始体验智能知识问答功能吧！**

有任何问题或建议，欢迎反馈。